---
title: "oven_sensor"
author: "WangYong"
date: "2022/9/7"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(RPostgres)
library(tsibble)
library(tibble)
library(DBI)
library(dbplyr)
library(ggplot2)
library(gridExtra)
library(ggforce)
library(gganimate)
library(gifski) #输出动画为GIF格式库
library(fpp2) # forest practice and princple 书的库
# Connect to a specific postgres database i.e. Heroku
 con <- dbConnect(RPostgres::Postgres(),dbname = 'shenvir-model', 
                  host = '172.16.16.56',
                  port = 5432,
                  user = 'postgres',
                  password = 'postgres1')

vdf_biz <- tbl(con, in_schema('analysis', "v_biz_data_detail")) 
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r temperator_oven2}
oven2_temp_tag <- 'SJ:B2_12HBK60CT901YG5M'

site_name <- '松江一期'

df_oven2_temp <- vdf_biz %>% 
  filter(tag==oven2_temp_tag,
         collection_node==site_name,
         data_value>0,
         between(biz_date, as.Date('2021-06-01'), as.Date('2021-06-25'))
         ) %>%
  select(biz_date, collection_node, data_value)%>%
  collect()
g<- ggplot(df_oven2_temp,aes(biz_date, data_value))
g+geom_line(color='blue')+
  labs(title=paste(oven2_temp_tag,'炉温变化趋势'))

```
# 1. generator analysis
## 1.2 device monitor time compare
### 显示小时平均功率图

```{r}
# 获取1#， 2# 发电机组小时数据 注：瞬时功率
tmp<- vdf_biz %>% 
  filter(tag %in% c('SJ:T1AIMW1.AV','SJ:T2AIMW1.AV'),biz_date >'2022-10-18') %>% 
  transmute(biz_date = sql("date_trunc('hour',biz_date)"),
            equipment_id,
            data_value) %>%
  group_by(biz_date, equipment_id) %>%
  summarise(data_value=avg(data_value)) %>% ungroup()
# glimpse(tmp)
  
# 画出小时平均功率变化图

g1<- ggplot(tmp,aes(x=biz_date, y=data_value)) +
     geom_line(aes(color=equipment_id)) 
     theme(legend.position="none")+
     labs(x='时间（小时）',y='MW.h', title='不同电机发电功率/小时')
g2<- ggplot(tmp,aes(equipment_id, data_value))+
  geom_boxplot(aes(color=equipment_id)) +labs(y='MW.h',title='不同发动机发电功率箱线图')
grid.arrange(g1,g2,ncol=2)

     
```
### 检查数据是否正态分布

```{r}
tmp.normal_test.result <- tmp %>%  ungroup()%>% group_by(equipment_id) %>%
  collect() %>% # 后续为特定R 函数,必须取回再计算
  summarise(
    p = shapiro.test(data_value)$p.value,
    statistic = shapiro.test(data_value)$statistic)

```

P 值小于 0.05 因此不符合正态分布， 所以参数检测不合适。 改用非参检验
```{r}
# t.test 比较1# ，2# 机组的发电功率平均值是否相同
t.test(data=tmp,data_value ~ equipment_id)

print('======================================================================')
var.test(data=tmp, data_value~equipment_id)

print('======================================================================')
wilcox.test(data=tmp,  data_value ~ equipment_id, paired = FALSE )
```
- 结论是不同， 一个是16Mw, 一个是18MW

# 2. oven analysis
## 2.1 find the distribution
```{r}
site_pattern <- '松江一期'
process_pattern <- '焚烧'

oven_steam_df <- vdf_biz %>% 
  filter(collection_node ==site_pattern, 
         process_name == process_pattern,
         #equipment_id =='#1',
         grepl( '实时蒸汽流量',data_desc),
         biz_date > '2022-09-01' ) %>%
  select(biz_date, collection_node,tag, data_desc,data_value) %>% 
  group_by(biz_date=sql("date_trunc('hour',biz_date)"),collection_node,data_desc)%>%
  summarize(data_value=mean(data_value)) %>%
  collect()

 g2<- ggplot(oven_steam_df,aes(data_desc, data_value))+
  geom_boxplot(aes(color=data_desc))
 
 g1<- ggplot(oven_steam_df,aes(x=biz_date, y=data_value))+
   geom_line(aes(color=data_desc),alpha=0.5)+
   theme_classic()+
   scale_x_continuous(breaks = seq(ISOdate(2022,9,15, tz=""),
                                by = "month",
                                length.out = 30*24)
                      )+
   theme(legend.position="none")
grid.arrange(g1,g2,ncol=2,nrow=2)
```
### 2.1.1 plot the 1# oven real time steaM
```{r}
oven_steam_df %>% 
  filter(
    biz_date>"2022-10-09 12:00", #& biz_date <"2022-10-11", 
          data_desc=="#1炉实时蒸汽流量") %>% 
  arrange(by=biz_date) %>% 
  ggplot(
    aes(biz_date, data_value,color=data_desc)
    )+
  geom_point()+
  scale_x_datetime(
    limits = c(as.POSIXct(Sys.Date()-5), NA),
    date_breaks='1 day',
    date_minor_breaks = "1 hour",
    date_labels='%d')+
  theme_classic()

```

## 2.2 compare if those oven steam are same by no-parameter test
```{r}
kruskl.result <- kruskal.test(
  data_value ~ data_desc,
  data = oven_steam_df )
kruskl.result
```
